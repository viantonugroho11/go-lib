name: Module Release
permissions:
  contents: write

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  module-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [config, kafka, xlog]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: Set up Go (for git-chglog)
      uses: actions/setup-go@v5
      with:
        go-version: "1.22.x"

    - name: Install git-chglog
      run: |
        go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Fetch tags
      run: git fetch --tags --force

    - name: Calculate changed files
      id: diff
      run: |
        BEFORE="${{ github.event.before }}"
        AFTER="${{ github.sha }}"
        if [ -z "$BEFORE" ]; then
          # Fallback to initial commit if 'before' is not available (e.g., manual dispatch)
          BEFORE=$(git rev-list --max-parents=0 HEAD | tail -n1)
        fi
        git diff --name-only "$BEFORE" "$AFTER" > /tmp/changed_files.txt
        echo "Changed files:"
        cat /tmp/changed_files.txt || true

    - name: Detect module change
      id: detect
      run: |
        MODULE="${{ matrix.module }}"
        if grep -E "^${MODULE}/" /tmp/changed_files.txt >/dev/null 2>&1; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Compute next tag for module
      id: version
      if: steps.detect.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        MODULE="${{ matrix.module }}"
        LAST_TAG=$(git tag --list "${MODULE}/v*" | sort -V | tail -n1)
        if [ -z "$LAST_TAG" ]; then
          NEW_VERSION="v0.1.0"
        else
          # Extract numeric version from the last tag (e.g., kafka/v1.2.3 -> 1.2.4)
          RAW="${LAST_TAG##*/}"     # v1.2.3
          NUM="${RAW#v}"            # 1.2.3
          IFS='.' read -r MAJOR MINOR PATCH <<< "$NUM"
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        fi
        NEW_TAG="${MODULE}/${NEW_VERSION}"
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Computed new tag: $NEW_TAG"

    - name: Generate module changelog
      if: steps.detect.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        MODULE="${{ matrix.module }}"
        NEW_TAG="${{ steps.version.outputs.new_tag }}"
        # Generate changelog scoped to the module path
        git-chglog --config .chglog/config.yml --tag-filter-pattern "^${MODULE}/v" --next-tag "$NEW_TAG" --path "$MODULE" -o "$MODULE/CHANGELOG.md"

    - name: Commit changelog (if changed)
      if: steps.detect.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        MODULE="${{ matrix.module }}"
        git add "$MODULE/CHANGELOG.md"
        if git diff --cached --quiet; then
          echo "No changelog changes to commit for $MODULE"
        else
          git commit -m "chore(${MODULE}): update changelog for ${{ steps.version.outputs.new_tag }}"
          git push
        fi

    - name: Create and push tag
      if: steps.detect.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        NEW_TAG="${{ steps.version.outputs.new_tag }}"
        echo "Tagging ${NEW_TAG}"
        git tag "${NEW_TAG}"
        git push origin "${NEW_TAG}"
